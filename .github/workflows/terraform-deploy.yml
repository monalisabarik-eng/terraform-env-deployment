name: Terraform Azure CI/CD

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

jobs:
  terraform:
    name: Terraform Workflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # ðŸ§ª Step 1: Detect Environment Based on Branch
      - name: Set environment
        id: envselect
        run: |
          BRANCH="${GITHUB_REF##*/}"
          echo "Branch: $BRANCH"
          if [[ "$BRANCH" == "main" ]]; then
            echo "env_name=prod" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "staging" ]]; then
            echo "env_name=staging" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == feature/* ]]; then
            echo "env_name=dev" >> $GITHUB_OUTPUT
          else
            echo "env_name=dev" >> $GITHUB_OUTPUT
          fi

      # âœ… Debug: confirm directory exists
      - name: Show repository structure
        run: |
          echo "Repository structure:"
          pwd
          ls -R .

      # ðŸ§© Step 2: Terraform Init
      - name: Terraform Init
        run: |
          cd ./envs/${{ steps.envselect.outputs.env_name }}
          terraform init -input=false

      # ðŸ§© Step 3: Terraform Validate
      - name: Terraform Validate
        run: |
          cd ./envs/${{ steps.envselect.outputs.env_name }}
          terraform validate

      # ðŸ§© Step 4: Terraform Plan
      - name: Terraform Plan
        id: plan
        run: |
          cd ./envs/${{ steps.envselect.outputs.env_name }}
          terraform plan -input=false -out=tfplan

      # ðŸ§© Step 5: Upload plan as artifact
      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ steps.envselect.outputs.env_name }}
          path: terraform/envs/${{ steps.envselect.outputs.env_name }}/tfplan

  # ---------------------------------------
  # ðŸ”¶ STAGING Deployment
  # ---------------------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: terraform
    environment:
      name: staging
      url: ${{ steps.output_url.outputs.app_url || '' }}
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        run: |
          cd ./envs/staging
          terraform init -input=false

      - name: Terraform Plan
        run: |
          cd ./envs/staging
          terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        run: |
          cd ./envs/staging
          terraform apply -auto-approve -input=false tfplan

  # ---------------------------------------
  # ðŸ”µ PRODUCTION Deployment
  # ---------------------------------------
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: prod
      url: ${{ steps.output_url.outputs.app_url || '' }}
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        run: |
          cd ./envs/prod
          terraform init -input=false

      - name: Terraform Plan
        run: |
          cd ./envs/prod
          terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        run: |
          cd ./envs/prod
          terraform apply -auto-approve -input=false tfplan
